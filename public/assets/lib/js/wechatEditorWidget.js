var Util=require("./util.js"),emotions=[{key:"[微笑]",val:"01"},{key:"[撇嘴]",val:"02"},{key:"[色]",val:"03"},{key:"[发呆]",val:"04"},{key:"[得意]",val:"05"},{key:"[流泪]",val:"06"},{key:"[害羞]",val:"07"},{key:"[闭嘴]",val:"08"},{key:"[睡]",val:"09"},{key:"[大哭]",val:"10"},{key:"[尴尬]",val:"11"},{key:"[发怒]",val:"12"},{key:"[调皮]",val:"13"},{key:"[呲牙]",val:"14"},{key:"[惊讶]",val:"15"},{key:"[难过]",val:"16"},{key:"[酷]",val:"17"},{key:"[冷汗]",val:"18"},{key:"[抓狂]",val:"19"},{key:"[吐]",val:"20"},{key:"[偷笑]",val:"21"},{key:"[愉快]",val:"22"},{key:"[白眼]",val:"23"},{key:"[傲慢]",val:"24"},{key:"[饥饿]",val:"25"},{key:"[困]",val:"26"},{key:"[惊恐]",val:"27"},{key:"[流汗]",val:"28"},{key:"[憨笑]",val:"29"},{key:"[悠闲]",val:"30"},{key:"[奋斗]",val:"31"},{key:"[咒骂]",val:"32"},{key:"[疑问]",val:"33"},{key:"[嘘]",val:"34"},{key:"[晕]",val:"35"},{key:"[疯了]",val:"36"},{key:"[衰]",val:"37"},{key:"[骷髅]",val:"38"},{key:"[敲打]",val:"39"},{key:"[再见]",val:"40"},{key:"[擦汗]",val:"41"},{key:"[抠鼻]",val:"42"},{key:"[鼓掌]",val:"43"},{key:"[糗大了]",val:"44"},{key:"[坏笑]",val:"45"},{key:"[左哼哼]",val:"46"},{key:"[右哼哼]",val:"47"},{key:"[哈欠]",val:"48"},{key:"[鄙视]",val:"49"},{key:"[委屈]",val:"50"},{key:"[快哭了]",val:"51"},{key:"[阴险]",val:"52"},{key:"[亲亲]",val:"53"},{key:"[吓]",val:"54"},{key:"[可怜]",val:"55"},{key:"[菜刀]",val:"56"},{key:"[西瓜]",val:"57"},{key:"[啤酒]",val:"58"},{key:"[篮球]",val:"59"},{key:"[乒乓]",val:"60"},{key:"[咖啡]",val:"61"},{key:"[饭]",val:"62"},{key:"[猪头]",val:"63"},{key:"[玫瑰]",val:"64"},{key:"[凋谢]",val:"65"},{key:"[嘴唇]",val:"66"},{key:"[爱心]",val:"67"},{key:"[心碎]",val:"68"},{key:"[蛋糕]",val:"69"},{key:"[闪电]",val:"70"},{key:"[炸弹]",val:"71"},{key:"[刀]",val:"72"},{key:"[足球]",val:"73"},{key:"[瓢虫]",val:"74"},{key:"[便便]",val:"75"},{key:"[月亮]",val:"76"},{key:"[太阳]",val:"77"},{key:"[礼物]",val:"78"},{key:"[拥抱]",val:"79"},{key:"[强]",val:"80"},{key:"[弱]",val:"81"},{key:"[握手]",val:"82"},{key:"[胜利]",val:"83"},{key:"[抱拳]",val:"84"},{key:"[勾引]",val:"85"},{key:"[拳头]",val:"86"},{key:"[差劲]",val:"87"},{key:"[爱你]",val:"88"},{key:"[NO]",val:"89"},{key:"[OK]",val:"90"},{key:"[爱情]",val:"91"},{key:"[飞吻]",val:"92"},{key:"[跳跳]",val:"93"},{key:"[发抖]",val:"94"},{key:"[怄火]",val:"95"},{key:"[转圈]",val:"96"},{key:"[磕头]",val:"97"},{key:"[回头]",val:"98"},{key:"[跳绳]",val:"99"},{key:"[投降]",val:"100"},{key:"[激动]",val:"101"},{key:"[乱舞]",val:"102"},{key:"[献吻]",val:"103"},{key:"[左太极]",val:"104"},{key:"[右太极]",val:"105"}],emotion2Image={text:function(e){return e=e.replace(/\n/g,"</p><p>"),e="<p>"+e+"</p>",e=e.replace(/\[(.*?)\]/,function(e){for(var i=0;i<emotions.length;i++)if(emotions[i].key==e){var t=(emotions[i].key,emotions[i].val);return'<img src="/assets/lib/img/emotion/'+t+'@2x.png" height="20" style="vertical-align:middle;" />'}return e})}},WechatEditorWidget=function(e,i){var t=this,l=$(e),a={header:{title:null},body:null,footer:{menu:null},webview:{}},s={"wechat.menu.click":[],"wechat.menu.add":[]},n=$.extend({title:"微信公众号",mode:"platform",menu:[],menuEditable:!1,menuEditLimit:{level1:3,level2:5},webviewTitle:null},i);this.init=function(){if("platform"==n.mode)l.append('<div class="box-header"><div class="more"><i class="uk-icon-user"></i></div><div class="title">...</div></div>'),l.append('<div class="box-body"><div class="body"></div></div>'),l.append('<div class="box-footer"><div class="bar"><i class="uk-icon-keyboard-o"></i></div><div class="menu"></div><div class="input"><input type="text" /><a href="javascript:;" class="send">发送</a></div></div>');else{if("webview"!=n.mode)return void alert("wechat mode incorrect");l.append('<div class="box-header"><div class="more"><i class="uk-icon-ellipsis-v"></i></div><div class="title">...</div></div>'),l.append('<div class="box-webview"><div class="body"><iframe src="about:blank"></iframe></div></div>')}a.header.title=l.find(".box-header > .title"),a.body=l.find(".box-body > .body"),a.webview=l.find(".box-webview > .body > iframe"),a.footer.menu=l.find(".box-footer > .menu"),a.footer.input=l.find(".box-footer > .input"),t.input.init(),t.menu.init(),t.webview.init(),t.title.set(n.title),t.menu.set(n.menu)},this.on=function(e,i){if(!(e in s))return alert("event : "+e+" not found"),!1;s[e].push(i)},this.trigger=function(e,i){if(!(e in s))return alert("event : "+e+" not found"),!1;for(var l=[],a=1;a<arguments.length;a++)l.push(arguments[a]);for(var a=0;a<s[e].length;a++)s[e][a].apply(t,l)},this.input={init:function(){n.menu.length||a.footer.input.hide()}},this.menu={init:function(){0==n.menu.length&&a.footer.menu.hide(),l.on("click",function(){a.footer.menu.find(".level-2").hide()}),a.footer.menu.on("click",".h-menu",function(e){var i=$(this),l=i.closest("li"),s=i.closest("ul"),v=null,d=0,r=0;if(s.hasClass("level-1"))a.footer.menu.find(".level-2").hide(),l.find(".level-2").show(),d=s.find(" > li").index(l)+1,v=n.menu[d-1];else if(s.hasClass("level-2")){r=s.find(" > li").index(l)+1;var c=s.closest("li"),o=c.closest("ul");d=o.find(" > li").index(c)+1,v=n.menu[d-1].child[r-1]}return n.menuEditable&&($(this).closest(".level-1").find(".item").removeClass("cur"),$(this).parent().addClass("cur")),t.trigger("wechat.menu.click",e,v,{level1:d,level2:r}),!1}),a.footer.menu.on("click",".h-add",function(e){var i=$(this),l=(i.closest("li"),i.closest("ul")),a=null,s=0,v=0;if(l.hasClass("level-1"))n.menu.push({id:0,title:"一级菜单",data:{type:"link",url:""},child:[]}),s=n.menu.length,a=n.menu[s-1];else if(l.hasClass("level-2")){var d=l.closest("li"),r=d.closest("ul");s=r.find(" > li").index(d)+1,n.menu[s-1].child.push({id:0,title:"二级菜单",data:{type:"link",url:""}}),v=n.menu[s-1].child.length,a=n.menu[s-1].child[v-1]}return t.menu.render(),t.menu.showLevel1(s),t.trigger("wechat.menu.add",e,a,{level1:s,level2:v}),!1})},render:function(){var e=n.menu,i=[];if(e)for(var t=0;t<e.length;t++){for(var l=e[t].child,s=[],v=0;v<l.length;v++)s.push('<li class="item"><a href="javascript:;" class="h-menu">'+l[v].title+"</a></li>");i.push('<li class="item"><a href="javascript:;" class="h-menu">'+e[t].title+"</a>"),i.push('<ul class="level-2">'+s.join("")+"</ul>"),i.push("</li>")}a.footer.menu.html('<ul class="level-1">'+i.join("")+"</ul>"),n.menuEditable&&(a.footer.menu.find(".level-1 > .item").each(function(e,i){var t=$(i);t.find(".level-2 > .item").length<n.menuEditLimit.level2&&t.find(".level-2").append('<li class="item"><a href="javascript:;" class="h-add"><i class="uk-icon-plus"></i></a></li>')}),a.footer.menu.find(".level-1 > .item").length<n.menuEditLimit.level1&&a.footer.menu.find(".level-1").append('<li class="item"><a href="javascript:;" class="h-add"><i class="uk-icon-plus"></i></a></li>')),e.length||n.menuEditable?(a.footer.menu.show(),a.footer.input.hide()):a.footer.input.show()},get:function(){return n.menu},set:function(e){e||(e=[]),n.menu=e,t.menu.render()},setPos:function(e,i){if(!(e.level1<1||e.level1>n.menu.length))if(0==e.level2)n.menu[e.level1-1].id=i.id,n.menu[e.level1-1].title=i.title,n.menu[e.level1-1].data=i.data,t.menu.render();else{if(e.level2<1||e.level2>n.menu[e.level1-1].child.length)return;n.menu[e.level1-1].child[e.level2-1].id=i.id,n.menu[e.level1-1].child[e.level2-1].title=i.title,n.menu[e.level1-1].child[e.level2-1].data=i.data,t.menu.render(),t.menu.showLevel1(e.level1)}},delete:function(e){if(!(e.level1<1||e.level1>n.menu.length))if(0==e.level2)n.menu.splice(e.level1-1,1),t.menu.render();else{if(e.level2<1||e.level2>n.menu[e.level1-1].child.length)return;n.menu[e.level1-1].child.splice(e.level2-1,1),t.menu.render(),t.menu.showLevel1(e.level1)}},showLevel1:function(e){if(0!=e){var i=a.footer.menu.find(".level-1 > .item");i.length<e||$(i[e-1]).find(".level-2").show()}},isLevel1:function(e){return e.level1>0&&e.level1<=n.menu.length&&0==e.level2},hasLevel2:function(e){return!!t.menu.isLevel1(e)&&n.menu[e.level1-1].child.length>0},generateKey:function(){var e=t.menu.get(),i=null;do{i="k_"+(new Date).getTime()}while(function(i){for(var t=0;t<e.length;t++){if("data"in e[t]&&"key"in e[t].data&&e[t].data.key==i)return!0;if("child"in e[t]&&e[t].child.length>0)for(var l=0;l<e[t].child.length;l++)if("data"in e[t].child[l]&&"key"in e[t].child[l].data&&e[t].child[l].data.key==i)return!0}return!1}(i));return i}},this.title={set:function(e){n.title=e,a.header.title.html(e)},get:function(){return n.title}},this.webview={init:function(){a.webview.on("load",function(){if(null==n.webviewTitle)try{var e=a.webview[0].contentWindow.document.title;t.title.set(e)}catch(e){t.title.set("预览")}})},navigate:function(e){if("webview"!=n.mode)return void alert("you can not call webview.navidate in "+n.mode+" mode");a.webview.attr("src",e),null==n.webviewTitle?t.title.set("正在加载..."):t.title.set(n.webviewTitle)}},this.msg={},this.Msg={},this.msg.clear=function(){a.body.html("")},this.Msg.Base=function(e){var i=this;this.$msg=$(e),this.remove=function(){i.$msg.remove()}},this.Msg.Notice=function(e){var i=this;t.Msg.Base.call(this,e),this.setText=function(e){i.$msg.find(".text").html(e)}},this.msg.notice=function(e){var i=a.body.append('<div class="msg"><div class="notice"><span class="text">'+e+"</span></div></div>");return new t.Msg.Notice(i)},this.Msg.Text=function(e){var i=this;t.Msg.Base.call(this,e),this.setAvatar=function(e){i.$msg.find(".avatar > img").attr("src",e)},this.setText=function(e){i.$msg.find(".text").html(e)}},this.msg.textLeft=function(e,i){i=emotion2Image.text(i);var l=a.body.append('<div class="msg"><div class="msg-text-left"><a href="javascript:;" class="avatar"><img src="'+e+'" alt=""/></a><i class="arrow"></i><div class="content"><div class="text">'+i+"</div></div></div></div>");return new t.Msg.Text(l)},this.msg.textRight=function(e,i){i=emotion2Image.text(i);var l=a.body.append('<div class="msg"><div class="msg-text-right"><a href="javascript:;" class="avatar"><img src="'+e+'" alt=""/></a><i class="arrow"></i><div class="content"><div class="text">'+i+"</div></div></div></div>");return new t.Msg.Text(l)},this.Msg.Template=function(e){var i=this;t.Msg.Base.call(this,e),this.setTitle=function(e){i.$msg.find(".msg-template > .link > .title").html(text)},this.setTime=function(e){i.$msg.find(".msg-template > .link > .time").html(e)},this.setContent=function(e){i.$msg.find(".msg-template > .link > .time").html(e)},this.setLink=function(e){i.$msg.find(".msg-template > .link").attr("href",e)}},this.msg.template=function(e,i,l,s){var n=a.body.append('<div class="msg"><div class="msg-template"><a href="'+s+'" class="link"><div class="title">'+e+'</div><div class="time">'+i+'</div><div class="content">'+l+'</div><div class="more">详情</div></a></div></div>');return new t.Msg.Template(n)},this.Msg.News=function(e){var i=this;t.Msg.Base.call(this,e),this.setOne=function(e,t){var l=i.$msg.find(" > div > a");if(!(e<0&&e>=count)){var a=$(l[e]);a.find(".title").html(t.title),a.attr("href",t.link),a.find(".cover > img").attr("src",t.cover),a.find(".time").html(t.time),a.find(".summary").html(t.summary)}}},this.msg.news=function(e){if(1==e.length){var i=e[0];i.summary=Util.text2html(i.summary);var l=a.body.append('<div class="msg"><div class="msg-news-single"><a class="head" href="'+i.link+'"><div class="title">'+i.title+'</div><div class="time">'+i.time+'</div><div class="cover"><img src="'+i.cover+'" alt=""/></div><div class="summary">'+i.summary+'</div><div class="more">查看全文</div></a></div></div>');return new t.Msg.News(l)}var s=[];s.push('<div class="msg"><div class="msg-news">');for(var n=0;n<e.length;n++){var i=e[n];i.summary=Util.text2html(i.summary),s.push('<a href="'+i.link+'"><div class="cover"><img src="'+i.cover+'" alt=""/></div><div class="title">'+i.title+"</div></a>")}s.push("</div></div>");var l=a.body.append(s.join(""));return new t.Msg.News(l)},this.Msg.Image=function(e){var i=this;t.Msg.Base.call(this,e),this.setAvatar=function(e){i.$msg.find(".avatar > img").attr("src",e)},this.setImage=function(e){i.$msg.find(".image > img").attr("src",avatar)}},this.msg.imageLeft=function(e,i){var l=a.body.append('<div class="msg"><div class="msg-text-left"><a href="javascript:;" class="avatar"><img src="'+e+'" alt=""/></a><i class="arrow"></i><div class="content"><a href="javascript:;" class="image"><img src="'+i+'" alt=""/></a></div></div></div>');return new t.Msg.Image(l)},this.msg.imageRight=function(e,i){var l=a.body.append('<div class="msg"><div class="msg-text-right"><a href="javascript:;" class="avatar"><img src="'+e+'" alt=""/></a><i class="arrow"></i><div class="content"><a href="javascript:;" class="image"><img src="'+i+'" alt=""/></a></div></div></div>');return new t.Msg.Image(l)},this.Msg.Sound=function(e){var i=this;t.Msg.Base.call(this,e),this.setAvatar=function(e){i.$msg.find(".avatar > img").attr("src",e)},this.setSecond=function(e){i.$msg.find(".time > span").html(e)},this.setRead=function(e){e?i.$msg.find(".time > i").hide():i.$msg.find(".time > i").show()},this.setPlaying=function(e){e?i.$msg.find(".icon").addClass("icon-play"):i.$msg.find(".icon").removeClass("icon-play")}},this.msg.soundLeft=function(e,i,l,s,n){var v=a.body.append('<div class="msg"><div class="msg-text-left"><a href="javascript:;" class="avatar"><img src="'+e+'" alt=""/></a><i class="arrow"></i><div class="content"><a href="javascript:;" class="sound"><div class="icon'+(n?" icon-play":"")+'"></div><div class="time"><span>'+l+'"</span> <i class="dot" '+(s?'style="display:none;"':"")+"></i></div></a></div></div></div>");return new t.Msg.Sound(v)},this.msg.soundRight=function(e,i,l,s,n){var v=a.body.append('<div class="msg"><div class="msg-text-right"><a href="javascript:;" class="avatar"><img src="'+e+'" alt=""/></a><i class="arrow"></i><div class="content"><a href="javascript:;" class="sound"><div class="icon'+(n?" icon-play":"")+'"></div><div class="time"><i class="dot" '+(s?'style="display:none;"':"")+"></i> <span>"+l+'"</span></div></a></div></div></div>');return new t.Msg.Sound(v)},this.init()};module.exports=WechatEditorWidget;