var Pager=require("./pager.js"),Table=require("./table.js"),Form=require("./form.js"),Dialog=require("./dialogPC.js"),Lister=function(e,a){var t=null;"table"in e&&(t=e.table);var i=$(t),r=null;"pager"in e&&(r=e.pager);var n=$(r),c=null;"search"in e&&(c=e.search);var s=$(c),d=this,l={page:1,pageSize:10,field:[],order:[],search:{}},o={enable:!1,map:{},putChecks:function(){if(o.enable){for(var e=d.getAllIds(),a=0;a<e.length;a++)delete o.map[""+e[a]];e=d.getSelectedIds();for(var a=0;a<e.length;a++)o.map[""+e[a]]=!0}},selectChecks:function(){o.enable&&d.setSelectedIds(d.getCrossPageSelectedIds())},clear:function(){o.map={},f.clearCheckbox()}},h=$.extend({server:"/path/to/server",entityCheckbox:!1,entityCheckboxCrossPage:!1,listRendered:null,listRefreshing:null,hashUrl:!0,itemViewedGroup:null},a);h.entityCheckboxCrossPage&&(o.enable=!0);var u=new Pager(n,function(e){l.page=e,d.load(!1)}),f=new Table(i,{entityCheckbox:h.entityCheckbox,checkboxChange:function(){o.putChecks()}});i.on("click","thead > tr > th",function(){if(!$(this).is("[data-orderAble]"))return!0;var e=$(this).attr("data-item"),a=$(this).attr("data-order");return a||(a="asc"),a="asc"==a?"desc":"asc",l.order[0]=[e,a],l.page=1,d.load(!0),!1}),s.on("click","[data-search-trigger]",function(){return o.clear(),d.setSearch(),d.load(!1),!1}),s.on("click","[data-search-button]",function(){return o.clear(),d.setSearch(),d.load(!1),!1}),s.on("click","[data-reset-search-button]",function(){return o.clear(),d.resetSearch(),d.load(!0),!1}),this.init=function(){var e=window.location.hash;0===e.indexOf("#")&&(e=e.substring(1));try{var a=JSON.parse(e);for(var t in a)t in l&&(l[t]=a[t])}catch(e){}},this.initSearch=function(){s.find("[data-search]").each(function(e,a){var t=$(a),i=t.attr("data-search");if(i in l.search){var r=t.data("widget");r?r.val(l.search[i]):t.val(l.search[i])}})},this.setSearch=function(){l.page=1,l.search=[],s.find("[data-search-field]").attr("data-lister-scanning","true"),s.find("[data-search-field]").each(function(e,a){var t=$(a);if(t.attr("data-lister-scanning")){t.attr("data-lister-scanning","");var i=t.attr("data-search-field"),r=t.attr("data-search-type"),n=null,c=t.data("widget");if(c)n=c.val();else{if((t.is("input[type=checkbox]")||t.is("input[type=radio]"))&&!t.is(":checked"))return;n=t.val()}if(""!==n&&null!==n){var d={};d[r]=n;var o=t.attr("data-search-group"),h=t.attr("data-search-exp");if(h&&(d.exp=h),o){d.group=o;s.find("[data-search-field="+i+"][data-search-group="+o+"]").each(function(e,a){var t=$(a);if(t.attr("data-lister-scanning")){t.attr("data-lister-scanning","");var i=t.attr("data-search-type"),r=t.attr("data-search-exp"),n=null,c=t.data("widget");n=c?c.val():t.is("input[type=checkbox]")||t.is("input[type=radio]")?t.is(":checked")?t.val():"":t.val(),""!==n&&(d[i]=n,r&&(d.exp=r))}})}var u={};u[i]=d,l.search.push(u)}}})},this.resetSearch=function(){l.page=1,l.search=[],s.find("[data-search-field]").attr("data-lister-scanning","true"),s.find("[data-search-field]").each(function(e,a){var t=$(a);if(t.attr("data-lister-scanning")){t.attr("data-lister-scanning","");var i=t.attr("data-search-field"),r=(t.attr("data-search-type"),t.data("widget"));r?r.val(null):t.is("input[type=checkbox]")||t.is("input[type=radio]")?t.is(":checked")&&t.prop("checked",!1):t.val(null);var n=t.attr("data-search-group");if(n){s.find("[data-search-field="+i+"][data-search-group="+n+"]").each(function(e,a){var t=$(a);if(t.attr("data-lister-scanning")){t.attr("data-lister-scanning","");var i=(t.attr("data-search-type"),t.attr("data-search-exp"),t.data("widget"));i?i.val(null):t.is("input[type=checkbox]")||t.is("input[type=radio]")?t.is(":checked")&&t.prop("checked",!1):t.val(null)}})}}})},this.setParam=function(e,a){e in l&&(l[e]=a)},this.setPageSize=function(e){l.pageSize=e,l.page=1,o.clear(),this.load(!1)},this.setPage=function(e){l.page=e},this.getParam=function(){return l},this.getPager=function(){return u},this.getTable=function(){return f},this.getAllIds=function(){var e=[];return i.find('[type=checkbox][name="__id[]"]').each(function(a,t){e.push($(t).val())}),e},this.getSelectedIds=function(){var e=[];return i.find('[type=checkbox][name="__id[]"]:checked').each(function(a,t){e.push($(t).val())}),e},this.setSelectedIds=function(e){i.find('[type=checkbox][name="__id[]"]').each(function(a,t){e.indexOf($(t).val())>=0&&$(t).prop("checked",!0)})},this.getCrossPageSelectedIds=function(){if(!o.enable)return[];var e=[];for(var a in o.map)e.push(a);return e},this.setItemViewed=function(e){if(h.itemViewedGroup&&"localStorage"in window){$(e).is("[data-item-id]")||(e=$(e).closest("[data-item-id]"));var a=$(e).attr("data-item-id");window.localStorage.setItem(h.itemViewedGroup+"-"+a+"-viewed",(new Date).getTime()+""),$(e).addClass("viewed")}},this.load=function(e){h.listRefreshing&&h.listRefreshing(),o.putChecks(),e?f.loading():Dialog.loadingOn(),$.post(h.server,l).done(function(a){h.hashUrl&&window.location.replace("#"+JSON.stringify(l)),e||Dialog.loadingOff(),Form.defaultCallback(a,{success:function(e){f.render(e.data),u.render(e.data.total,e.data.pageSize,e.data.page,e.data.maxRecords),o.selectChecks(),f.activeSelectedRow(),h.itemViewedGroup&&"localStorage"in window&&f.getContainer().find("[data-item-id]").each(function(e,a){var t=$(a).attr("data-item-id");window.localStorage.getItem(h.itemViewedGroup+"-"+t+"-viewed")&&$(a).addClass("viewed")}),h.listRendered&&h.listRendered()}})}).fail(function(a){e||Dialog.loadingOff(),Form.defaultCallback(a)})},this.init(),this.initSearch(),this.load(!0)};module.exports=Lister;