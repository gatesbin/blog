var $=require("jquery"),Form=require("./form.js"),Widget={},WidgetDialog=null;Widget.Radio=function(t){var e=$(t),a=this;this.value=null;this.val=function(t){if(void 0===t)return a.value;var i=e.find('input[type=radio][value="'+t+'"]');e.find("label").removeClass("select"),e.find("input[type=radio]").prop("checked",!1),i.length?(a.value=i.val(),i.parent().addClass("select"),setTimeout(function(){i.prop("checked",!0),e.trigger("widget.radio.change",[a])},0)):(a.value=null,e.trigger("widget.radio.change",[a]))},e.on("click","label",function(){var t=$(this).find("input[type=radio]");return t.val()!=a.val()||e.is("[data-tab-only]")?a.val(t.val()):a.val(null),!1}),function(){var t=e.find("input[type=radio]:checked");t.length?a.val(t.val()):a.val(null)}()},Widget.RadioChoose=function(t){var e=$(t),a=this;this.value=null,this.title="请选择",this.server=null,this.width="600px",this.height="80%";this.val=function(t){if(void 0===t)return a.value;if(a.value=t,e.find("label").removeClass("select"),e.find("input[type=radio]").prop("checked",!1),t){var i=e.find('input[type=radio][value="'+t._value+'"]');if(i.length)i.parent().addClass("select"),i.prop("checked",!0);else{var n=e.find("label.custom");n.find("input[type=radio]").attr("value",t._value).prop("checked",!0),n.find("[data-name]").html(t._name),n.addClass("select")}}else a.value=null;e.trigger("widget.radio.change",[a])},e.on("click","label",function(){if($(this).hasClass("custom")){var t={title:a.title,width:a.width,height:a.height,closeCallback:function(){var t=window.__widget.choose.value;if(null!==t)return"_value"in t?"_name"in t?void a.val(t):(alert("select data item must contains _name"),!1):(alert("select data item must contains _value"),!1)}};window.__widget.choose.value=null,WidgetDialog.dialog(a.server,t)}else{var e=$(this).find("input[type=radio]"),i=e.closest("label"),n=i.find("input[type=radio]").val(),l=i.find("[data-name]").text(),d=a.val();d&&d._value==n?a.val(null):a.val({_name:l,_value:n})}return!1}),function(){"__widget"in window||(window.__widget={}),window.__widget.choose={value:null},a.server=e.attr("data-server"),e.attr("data-title")&&(a.title=e.attr("data-title")),e.attr("data-width")&&(a.width=e.attr("data-width")),e.attr("data-height")&&(a.height=e.attr("data-height"));var t=e.find("input[type=radio]:checked");if(t.length){var i=t.closest("label"),n=i.find("input[type=radio]").val(),l=i.find("[data-name]").text();a.val({_name:l,_value:n})}else a.val(null)}()},Widget.Choose=function(t){var e=$(t),a=this;this.value=null,this.title="请选择",this.server=null,this.width="600px",this.height="80%";this.val=function(t){if(void 0==t)return a.value;a.value=t,a.value._value?(e.find("[data-name]").html(a.value._name),e.find(".clear").show()):(e.find("[data-name]").html('<span class="empty">[ 点击选择 ]</span>'),e.find(".clear").hide()),e.find("[data-value]").val(a.value._value),e.trigger("widget.choose.change",[a])},e.on("click",".value",function(){var t={title:a.title,width:a.width,height:a.height,closeCallback:function(){var t=window.__widget.choose.value;if(null!==t)return"_value"in t?"_name"in t?void a.val(t):(alert("select data item must contains _name"),!1):(alert("select data item must contains _value"),!1)}};return window.__widget.choose.value=null,WidgetDialog.dialog(a.server,t),!1}),e.on("click",".clear",function(){return a.val({_value:null,_name:null}),!1}),function(){"__widget"in window||(window.__widget={}),window.__widget.choose={value:null},a.server=e.attr("data-server"),e.attr("data-title")&&(a.title=e.attr("data-title")),e.attr("data-width")&&(a.width=e.attr("data-width")),e.attr("data-height")&&(a.height=e.attr("data-height"));var t=e.find("[data-value]").val(),i=e.find("[data-name]").html();a.val({_value:t,_name:i}),e.css("visibility","visible")}()},Widget.Category=function(t){var e=$(t),a=this,i=e.find("[data-select]");this.value=null,this.title=null,this.server=null,this.dynamic=!1,this.seperator=",",this.maxLevel=0,this.data=[],this.initValues=[],this.initTitles=[];var n=function(t,e,i){i=i||null,$.get(a.server,{pid:t,title:i},function(t){Form.defaultCallback(t,{success:function(t){e(t.data)}})})},l=function(){var t=e.find("[data-id]").val(),i=e.find("[data-title]").val();if(t)for(var n=t.split(a.seperator),l=0;l<n.length;l++)n[l]&&a.initValues.push(n[l]);else if(i)for(var d=i.split(a.seperator),l=0;l<d.length;l++)d[l]&&a.initTitles.push(d[l])},d=function(t,n){for(var l=[],d=a.data,r=0;r<d.length;r++)d[r].pid==n&&l.push({id:d[r].id,title:d[r].title});if(i.find("select").each(function(e,a){parseInt($(a).attr("data-level"))>=t&&$(a).remove()}),l.length){var u=[];u.push('<select data-level="'+t+'" class="select">'),u.push('<option value="">请选择</option>');for(var r=0;r<l.length;r++)u.push('<option value="'+l[r].id+'">'+l[r].title+"</option>");u.push("</select>"),i.append(u.join("")),e.trigger("widget.category.rendered",[a])}},r=function(t){i.find("select").each(function(e,a){parseInt($(a).attr("data-level"))>=t&&$(a).remove()})},u=function(){e.find("[data-id]").val(""),e.find("[data-title]").val("");var t=[],n=[];i.find("select").each(function(e,a){var i=$(a).val();i&&(t.push(i),n.push($(a).find("option:selected").text()))}),e.find("[data-id]").each(function(e,i){var n=$(i).attr("data-level");n?(n=parseInt(n))<=t.length&&$(i).val(t[n-1]):$(i).val(t.join(a.seperator))}),e.find("[data-title]").each(function(t,e){var i=$(e).attr("data-level");i?(i=parseInt(i))<=n.length&&$(e).val(n[i-1]):$(e).val(n.join(a.seperator))}),a.value=t,a.title=n,e.trigger("widget.category.change",[a])};this.val=function(t){if(void 0==t)return a.value;if(a.initValues=t,!a.initValues.length)return void r(1);if(a.dynamic)n(a.initValues.join(","),function(t){t.sort(function(t,e){return t.sort-e.sort}),a.data=t,i.html(""),d(1,0);for(var e=0;e<a.initValues.length-1;e++){var n=e+2,l=a.initValues[e];(0==a.maxLevel||n<=a.maxLevel)&&d(n,l)}i.find("select").each(function(t,e){var i=$(e).attr("data-level");i&&(i=parseInt(i))<=a.initValues.length&&$(e).val(a.initValues[i-1])}),a.initValues=[]});else{for(var e=0;e<a.initValues.length;e++){var l=e+1,u=a.initValues[e],s=i.find("select");if(s.length>=l){$(s.get(l-1)).val(u).trigger("change")}}a.initValues=[]}},this.titleVal=function(t){if(void 0==t)return a.title;if(a.initTitles=t,!a.initTitles.length)return void r(1);if(a.dynamic)n(null,function(t){t.sort(function(t,e){return t.sort-e.sort}),a.data=t,i.html(""),d(1,0);for(var e=0;e<a.initTitles.length-1;e++){var n=e+2,l=a.initTitles[e],r=i.find("select[data-level="+(n-1)+"]"),u=null;r.find("option").each(function(t,e){$(e).text()==l&&(u=$(e).attr("value"))}),null!==u&&(0==a.maxLevel||n<=a.maxLevel)&&d(n,u)}i.find("select").each(function(t,e){var i=$(e).attr("data-level");if(i&&(i=parseInt(i))<=a.initTitles.length){var n=a.initTitles[i-1];$(e).find("option").each(function(t,e){$(e).text()==n&&$(e).prop("selected",!0)})}})},a.initTitles.join(","));else for(var e=0;e<a.initTitles.length;e++){var l=e+1,u=a.initTitles[e],s=i.find("select");if(s.length>=l){var v=$(s.get(l-1));v.find("option").each(function(t,e){$(e).text()==u&&v.val($(e).attr("value")).trigger("change")})}}},i.on("change","select",function(){var t=parseInt($(this).attr("data-level")),e=$(this).val();return a.dynamic?(0==a.maxLevel||t<a.maxLevel)&&(e>0?$.get(a.server,{pid:e},function(n){Form.defaultCallback(n,{success:function(n){if(a.data=n.data,d(t+1,e),a.initValues&&a.initValues.length){var l=i.find("select");if(!l.length)return;var r=$(l.get(l.length-1));r.val(a.initValues.splice(0,1)[0]).trigger("change")}else if(a.initTitles&&a.initTitles.length){var l=i.find("select");if(!l.length)return;var r=$(l.get(l.length-1)),s=a.initTitles.splice(0,1)[0];r.find("option").each(function(t,e){$(e).text()==s&&r.val($(e).attr("value")).trigger("change")})}u()}})}):(r(t+1),u())):(0==a.maxLevel||t<a.maxLevel)&&(e>0?d(t+1,e):r(t+1),u()),!1}),function(){if(a.server=e.attr("data-server"),!a.server)return void i.html("[错误]server为空");a.dynamic=!!e.attr("data-dynamic"),e.attr("data-seperator")&&(a.seperator=e.attr("data-seperator")),e.attr("data-max-level")&&(a.maxLevel=e.attr("data-max-level")),l(),a.dynamic&&a.initValues.length?a.val(a.initValues):a.dynamic&&a.initTitles.length?a.titleVal(a.initTitles):n(0,function(t){t.sort(function(t,e){return t.sort-e.sort}),a.data=t,i.html(""),d(1,0),a.initValues.length?a.val(a.initValues):a.initTitles.length&&a.titleVal(a.initTitles)}),i.html("<span>正在加载...</span>")}()},Widget.Values=function(t){var e=$(t),a=e.find(".list"),i=e.find(".button"),n=e.find(".list-item-template"),l=this;this.value=[],this.title="请选择",this.server=null,this.width="600px",this.height="80%",this.unique=!1;this.val=function(t){if(void 0==t)return l.value;if(l.unique){for(var d=[],r={},u=0;u<t.length;u++){var s="v-"+t[u]._value;s in r||(r[s]=!0,d.push(t[u]))}t=d}l.value=t,a.html(""),t=l.value;for(var u=0;u<t.length;u++){var v=$(n.html());v.attr("data-value",t[u]._value),v.attr("data-name",t[u]._name),v.find("[data-value]").val(t[u]._value),v.find("[data-value-html]").html(t[u]._value),v.find("[data-name]").val(t[u]._name),v.find("[data-name-html]").html(t[u]._name),a.append(v)}t.length?i.find(".clear").css("visibility","visible"):i.find(".clear").css("visibility","hidden"),e.trigger("widget.values.change",[l])},e.on("click",".list .remove",function(){for(var t=$(this).closest(".item").attr("data-value"),e=0;e<l.value.length;e++)t==l.value[e]._value&&l.value.splice(e,1);return l.val(l.value),!1}),i.on("click",".clear",function(){return l.val([]),!1}),i.on("click",".add",function(){var t={title:l.title,width:l.width,height:l.height,closeCallback:function(){var t=l.value,e=window.__widget.values.value;if(null!==e){for(var a=0;a<e.length;a++){if(!("_value"in e[a]))return alert("select data item must contains _value"),!1;if(!("_name"in e[a]))return alert("select data item must contains _name"),!1;t.push(e[a])}l.val(t)}}};return window.__widget.values.value=null,WidgetDialog.dialog(l.server,t),!1}),function(){"__widget"in window||(window.__widget={}),window.__widget.values={value:null},l.server=e.attr("data-server"),e.attr("data-title")&&(l.title=e.attr("data-title")),e.attr("data-width")&&(l.width=e.attr("data-width")),e.attr("data-height")&&(l.height=e.attr("data-height")),e.attr("data-unique")&&(l.unique=e.attr("data-unique"));var t=[];a.find(".item").each(function(e,a){t.push({_name:$(this).attr("data-name"),_value:$(this).attr("data-value")})}),l.val(t)}()},Widget.Tab=function(t){var e=$(t),a=this;if(!e.is("[data-disabled]")){this.value=null;this.val=function(t){if(void 0===t)return a.value;a.value=t;var i=e.find("> .head > .menu"),n=i.find("> a"),l=$(n.get(t)),d=e.find("> .body > .item");d.removeClass("cur"),$(d.get(t)).addClass("cur"),n.removeClass("cur"),l.addClass("cur");var r=e.find("> [data-tab-value]");r.length&&r.val(l.attr("data-value")),e.trigger("widget.tab.change",[a])},e.on("click","> .head > .menu > a",function(){var t=$(this),e=t.parent().find("a"),i=e.index(t);return a.val(i),!1}),function(){var t=e.find("> .head > .menu"),i=t.find("> a"),n=0,l=e.find("> [data-tab-value]"),d=t.find("> a.cur");l.length&&l.val()?(d=t.find("> a[data-value="+l.val()+"]"),n=i.index(d)):d.length&&(n=i.index(d)),a.val(n)}()}},Widget.Attr=function(t){var e=$(t),a=this;if(!e.is("[data-disabled]")){this.value=null;this.val=function(t){if(void 0===t)return a.value;a.value=t},this.clear=function(){e.find("[data-list]").html("")},this.tpl=function(){return e.find("[data-tpl]").html()},this.add=function(t){e.find("[data-list]").append(t)},e.on("click","[data-add]",function(){var t=e.find("[data-tpl]").html();return e.find("[data-list]").append(t),!1}),e.on("click","[data-remove]",function(){return $(this).closest(".item").remove(),!1})}},Widget.init=function(t){WidgetDialog=t||null,$(".widget-radio").each(function(t,e){$(e).data("widget")||$(e).data("widget",new Widget.Radio(e))}),$(".widget-radio-choose").each(function(t,e){$(e).data("widget")||$(e).data("widget",new Widget.RadioChoose(e))}),$(".widget-choose").each(function(t,e){$(e).data("widget")||$(e).data("widget",new Widget.Choose(e))}),$(".widget-category").each(function(t,e){$(e).data("widget")||$(e).data("widget",new Widget.Category(e))}),$(".widget-values").each(function(t,e){$(e).data("widget")||$(e).data("widget",new Widget.Values(e))}),$(".widget-tab").each(function(t,e){$(e).data("widget")||$(e).data("widget",new Widget.Tab(e))}),$(".widget-attr").each(function(t,e){$(e).data("widget")||$(e).data("widget",new Widget.Attr(e))})},module.exports=Widget;