var Pager=require("./pager.js"),AdvancedTable=require("./advancedTable.js"),Form=require("./form.js"),Dialog=require("./dialogPC.js"),Lister=function(container,option){var tableContainer=null;"table"in container&&(tableContainer=container.table);var $tableContainer=$(tableContainer),pageContainer=null;"pager"in container&&(pageContainer=container.pager);var $pageContainer=$(pageContainer),searchContainer=null;"search"in container&&(searchContainer=container.search);var $searchContainer=$(searchContainer),me=this,param={page:1,pageSize:10,field:[],order:[],search:[]},data=null,opt=$.extend({server:"/path/to/server",editQuickServer:"/path/to/edit/quick",entityCheckbox:!1,listRefreshing:null,listRendered:null,hashUrl:!0},option),pager=new Pager($pageContainer,function(a){param.page=a,me.load(!1)}),table=new AdvancedTable($tableContainer,{entityCheckbox:opt.entityCheckbox});this.getPager=function(){return pager},this.getData=function(){return data},this.init=function(){var a=window.location.hash;0===a.indexOf("#")&&(a=a.substring(1));try{a=decodeURIComponent(a);var t=JSON.parse(a);for(var e in t)e in param&&(param[e]=t[e])}catch(a){}},this.initSearch=function(){$searchContainer.on("click","[data-search-button]",function(){return param.page=1,me.setSearch(),me.load(!0),!1}),$searchContainer.on("click","[data-reset-search-button]",function(){return me.resetSearch(),me.load(!0),!1}),$searchContainer.on("click","[data-expand-search-button]",function(){return $searchContainer.find(".field.field-auto-hide").is(":visible")?$searchContainer.find(".field.field-auto-hide").hide():$searchContainer.find(".field.field-auto-hide").css("display","inline-block"),!1}),$searchContainer.find("[data-search-field]").each(function(a,t){for(var e=$(t),i=e.closest(".field"),r=e.attr("data-search-field"),n=e.attr("data-search-type"),c=e.attr("data-search-group"),o=e.data("widget"),a=0;a<param.search.length;a++){var s=param.search[a],d=null,l={};for(var h in s)d=h,l=s[h];for(var u in l)if(r==d&&n==u){if(!c){o?o.val(l[u]):e.val(l[u]),i.is(".field-auto-hide")&&i.removeClass("field-auto-hide");break}if("group"in l&&l.group==c){o?o.val(l[u]):e.val(l[u]),i.is(".field-auto-hide")&&i.removeClass("field-auto-hide");break}}}})},this.initTable=function(){$tableContainer.on("click","[data-item-edit-quick]",function(){var id=$(this).closest("tr[data-item-id]").attr("data-item-id");eval("var data = "+$(this).attr("data-item-edit-quick")+";"),data._id=id;var send=function(){$.post(opt.editQuickServer,data,function(a){Form.defaultCallback(a,{success:function(a){me.load(!1)}})})},confirm=$(this).attr("data-confirm");return confirm?Dialog.confirm(confirm,function(){send()}):send(),!1})},this.setSearch=function(){param.search=[],$searchContainer.find("[data-search-field]").attr("data-lister-scanning","true"),$searchContainer.find("[data-search-field]").each(function(a,t){var e=$(t);if(e.attr("data-lister-scanning")){e.attr("data-lister-scanning","");var i=e.attr("data-search-field"),r=e.attr("data-search-type"),n=null,c=e.data("widget");if(c)n=c.val();else{if((e.is("input[type=checkbox]")||e.is("input[type=radio]"))&&!e.is(":checked"))return;n=e.val()}if(""!==n&&null!==n){var o={};o[r]=n;var s=e.attr("data-search-group"),d=e.attr("data-search-exp");if(d&&(o.exp=d),s){o.group=s;$searchContainer.find("[data-search-field="+i+"][data-search-group="+s+"]").each(function(a,t){var e=$(t);if(e.attr("data-lister-scanning")){e.attr("data-lister-scanning","");var i=e.attr("data-search-type"),r=e.attr("data-search-exp"),n=null,c=e.data("widget");n=c?c.val():e.is("input[type=checkbox]")||e.is("input[type=radio]")?e.is(":checked")?e.val():"":e.val(),""!==n&&(o[i]=n,r&&(o.exp=r))}})}var l={};l[i]=o,param.search.push(l)}}})},this.resetSearch=function(){param.search=[],$searchContainer.find("[data-search-field]").attr("data-lister-scanning","true"),$searchContainer.find("[data-search-field]").each(function(a,t){var e=$(t);if(e.attr("data-lister-scanning")){e.attr("data-lister-scanning","");var i=e.attr("data-search-field"),r=(e.attr("data-search-type"),e.data("widget"));r?r.val(null):e.is("input[type=checkbox]")||e.is("input[type=radio]")?e.is(":checked")&&e.prop("checked",!1):e.val(null);var n=e.attr("data-search-group");if(n){$searchContainer.find("[data-search-field="+i+"][data-search-group="+n+"]").each(function(a,t){var e=$(t);if(e.attr("data-lister-scanning")){e.attr("data-lister-scanning","");var i=(e.attr("data-search-type"),e.attr("data-search-exp"),e.data("widget"));i?i.val(null):e.is("input[type=checkbox]")||e.is("input[type=radio]")?e.is(":checked")&&e.prop("checked",!1):e.val(null)}})}}})},this.setPageSize=function(a){param.pageSize=a},this.setPage=function(a){param.page=a},this.setParam=function(a,t){a in param&&(param[a]=t)},this.getParam=function(){return param},this.setOption=function(a,t){opt[a]=t},this.getTable=function(){return table},this.load=function(a){opt.listRefreshing&&opt.listRefreshing(),a?table.loading(!0):Dialog.loadingOn(),data=null,$.post(opt.server,param).done(function(t){opt.hashUrl&&window.location.replace("#"+JSON.stringify(param)),a?table.loading(!1):Dialog.loadingOff(),Form.defaultCallback(t,{success:function(a){data=a.data,table.render(a.data),pager.render(a.data.total,a.data.pageSize,a.data.page),opt.listRendered&&opt.listRendered()}})}).fail(function(t){try{a?table.loading(!1):Dialog.loadingOff(),Form.defaultCallback(t)}catch(a){}})},this.init(),this.initSearch(),this.initTable(),this.load(!0)};module.exports=Lister;